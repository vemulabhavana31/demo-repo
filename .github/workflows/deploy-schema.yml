name: Deploy Snowflake Schema Change

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      # Snowflake connection details (from GitHub Secrets)
      SNOWFLAKE_ACCOUNT: ${{ secrets.DEMO_ACCOUNT }}
      SNOWFLAKE_USER: ${{ secrets.DEMO_USER }}
      SNOWFLAKE_PRIVATE_KEY: ${{ secrets.DEMO_PRIVATE_KEY }}
      SNOWFLAKE_AUTHENTICATOR: snowflake_jwt
      SNOWFLAKE_ROLE: ${{ secrets.DEMO_ROLE }}
      SNOWFLAKE_WAREHOUSE: ${{ secrets.DEMO_WAREHOUSE }}

      # Variable passed to schemachange (used in SQL)
      DATABASE_NAME: ${{ secrets.DEMO_DB }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install schemachange
        run: |
          pip install schemachange

      - name: Run schemachange
        run: |
          schemachange deploy \
            --vars "{\"database_name\":\"$DATABASE_NAME\"}"
